---
globs: src/store/**/*
description: çŠ¶æ€ç®¡ç†è§„èŒƒ - Zustand ä½¿ç”¨æŒ‡å—ã€Store åˆ›å»ºè§„èŒƒã€é€‰æ‹©å™¨ Hooksã€æŒä¹…åŒ–é…ç½®
---

# çŠ¶æ€ç®¡ç†è§„èŒƒï¼ˆZustandï¼‰

## ğŸ“š Zustand æ¦‚è¿°

é¡¹ç›®ä½¿ç”¨ [Zustand](https://github.com/pmndrs/zustand) ä½œä¸ºå…¨å±€çŠ¶æ€ç®¡ç†å·¥å…·ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© Zustandï¼Ÿ

- âœ… **ç®€å•æ˜“ç”¨**ï¼šAPI ç®€æ´ï¼Œå­¦ä¹ æˆæœ¬ä½
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šåŸºäº React Hooksï¼Œæ”¯æŒç»†ç²’åº¦è®¢é˜…
- âœ… **TypeScript å‹å¥½**ï¼šå®Œæ•´çš„ç±»å‹æ”¯æŒ
- âœ… **æ— æ ·æ¿ä»£ç **ï¼šä¸éœ€è¦ actionsã€reducers ç­‰æ¦‚å¿µ
- âœ… **ä¸­é—´ä»¶æ”¯æŒ**ï¼šæ”¯æŒ persistã€devtools ç­‰ä¸­é—´ä»¶
- âœ… **ä½“ç§¯å°**ï¼šä»… 1.2KB (gzipped)

## ğŸ“ ç›®å½•ç»“æ„

```
src/store/
â”œâ”€â”€ index.ts                    # Store ç»Ÿä¸€å¯¼å‡º
â””â”€â”€ modules/                    # Store æ¨¡å—
    â”œâ”€â”€ userStore.ts           # ç”¨æˆ·çŠ¶æ€ç®¡ç†
    â””â”€â”€ appStore.ts            # åº”ç”¨å…¨å±€çŠ¶æ€
```

## ğŸ—ï¸ åˆ›å»º Store

### åŸºæœ¬ç»“æ„

å‚è€ƒæ–‡ä»¶ï¼š[src/store/modules/userStore.ts](mdc:src/store/modules/userStore.ts)

```typescript
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'
import type { UserInfo } from '@/services'

/**
 * ç”¨æˆ·çŠ¶æ€æ¥å£
 */
interface UserState {
  // çŠ¶æ€
  token: string | null
  userInfo: UserInfo | null
  isLogin: boolean

  // Actions
  setToken: (token: string) => void
  setUserInfo: (userInfo: UserInfo) => void
  login: (token: string, userInfo: UserInfo) => void
  logout: () => void
  updateUserInfo: (userInfo: Partial<UserInfo>) => void
}

/**
 * ç”¨æˆ·çŠ¶æ€ç®¡ç†
 * ä½¿ç”¨ persist ä¸­é—´ä»¶æŒä¹…åŒ–åˆ° localStorage
 */
export const useUserStore = create<UserState>()(
  persist(
    (set, get) => ({
      // åˆå§‹çŠ¶æ€
      token: null,
      userInfo: null,
      isLogin: false,

      // è®¾ç½® token
      setToken: token => {
        set({ token, isLogin: !!token })
      },

      // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
      setUserInfo: userInfo => {
        set({ userInfo })
      },

      // ç™»å½•
      login: (token, userInfo) => {
        set({
          token,
          userInfo,
          isLogin: true,
        })
      },

      // ç™»å‡º
      logout: () => {
        set({
          token: null,
          userInfo: null,
          isLogin: false,
        })
      },

      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      updateUserInfo: newUserInfo => {
        const currentUserInfo = get().userInfo
        if (currentUserInfo) {
          set({
            userInfo: {
              ...currentUserInfo,
              ...newUserInfo,
            },
          })
        }
      },
    }),
    {
      name: 'user-storage', // localStorage çš„ key
      storage: createJSONStorage(() => localStorage),
      // å¯é€‰ï¼šæŒ‡å®šéœ€è¦æŒä¹…åŒ–çš„å­—æ®µ
      partialize: state => ({
        token: state.token,
        userInfo: state.userInfo,
        isLogin: state.isLogin,
      }),
    }
  )
)

// å¯¼å‡ºé€‰æ‹©å™¨ hooksï¼ˆç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰
export const useToken = () => useUserStore(state => state.token)
export const useUserInfo = () => useUserStore(state => state.userInfo)
export const useIsLogin = () => useUserStore(state => state.isLogin)
```

## ğŸ’¡ ä½¿ç”¨ Store

### 1. åŸºç¡€ç”¨æ³•

```typescript
import { useUserStore } from '@/store'

function MyComponent() {
  // è·å–æ•´ä¸ª store
  const { token, userInfo, login, logout } = useUserStore()

  // ç™»å½•
  const handleLogin = async () => {
    const res = await UserAPI.login({ username, password })
    login(res.token, res.userInfo)
  }

  // ç™»å‡º
  const handleLogout = () => {
    logout()
  }

  return (
    <div>
      <p>Token: {token}</p>
      <p>ç”¨æˆ·å: {userInfo?.username}</p>
      <button onClick={handleLogin}>ç™»å½•</button>
      <button onClick={handleLogout}>ç™»å‡º</button>
    </div>
  )
}
```

### 2. ä½¿ç”¨é€‰æ‹©å™¨ Hooksï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

```typescript
import { useIsLogin, useUserInfo } from '@/store'

function UserProfile() {
  // âœ… æ¨èï¼šåªè®¢é˜… isLogin çŠ¶æ€ï¼Œå…¶ä»–çŠ¶æ€å˜åŒ–ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
  const isLogin = useIsLogin()

  // âœ… æ¨èï¼šåªè®¢é˜… userInfo çŠ¶æ€
  const userInfo = useUserInfo()

  if (!isLogin) {
    return <div>è¯·å…ˆç™»å½•</div>
  }

  return <div>æ¬¢è¿, {userInfo?.username}</div>
}
```

### 3. è‡ªå®šä¹‰é€‰æ‹©å™¨

```typescript
import { useUserStore } from '@/store'

function MyComponent() {
  // âœ… è‡ªå®šä¹‰é€‰æ‹©å™¨ï¼Œåªè®¢é˜…éœ€è¦çš„æ•°æ®
  const username = useUserStore(state => state.userInfo?.username)
  const hasAvatar = useUserStore(state => !!state.userInfo?.avatar)

  return (
    <div>
      <p>{username}</p>
      <p>{hasAvatar ? 'æœ‰å¤´åƒ' : 'æ— å¤´åƒ'}</p>
    </div>
  )
}
```

### 4. åœ¨éç»„ä»¶ä¸­ä½¿ç”¨

```typescript
import { useUserStore } from '@/store'

// åœ¨ API æ‹¦æˆªå™¨ä¸­è·å– token
const token = useUserStore.getState().token

// åœ¨éç»„ä»¶ä¸­è°ƒç”¨ action
useUserStore.getState().logout()

// è®¢é˜…çŠ¶æ€å˜åŒ–
const unsubscribe = useUserStore.subscribe(
  state => state.token,
  token => {
    console.log('Token changed:', token)
  }
)

// å–æ¶ˆè®¢é˜…
unsubscribe()
```

## ğŸ¨ æœ€ä½³å®è·µ

### 1. çŠ¶æ€è®¾è®¡åŸåˆ™

```typescript
// âœ… æ¨èï¼šå°†å…¨å±€å…±äº«çš„çŠ¶æ€æ”¾å…¥ store
const { userInfo, isLogin } = useUserStore()
const { theme, locale } = useAppStore()

// âŒ ä¸æ¨èï¼šå°†ç»„ä»¶å±€éƒ¨çŠ¶æ€æ”¾å…¥ store
// è¡¨å•è¾“å…¥ã€å¼¹çª—æ˜¾ç¤ºç­‰å±€éƒ¨çŠ¶æ€åº”è¯¥ç”¨ useState
const [formData, setFormData] = useState({})
const [modalVisible, setModalVisible] = useState(false)
```

### 2. é€‰æ‹©å™¨ä½¿ç”¨

```typescript
// âœ… æ¨èï¼šä½¿ç”¨é€‰æ‹©å™¨ Hooks è¿›è¡Œç»†ç²’åº¦è®¢é˜…
const isLogin = useIsLogin() // åªè®¢é˜… isLogin

// âœ… æ¨èï¼šè‡ªå®šä¹‰é€‰æ‹©å™¨
const username = useUserStore(state => state.userInfo?.username)

// âŒ ä¸æ¨èï¼šè®¢é˜…æ•´ä¸ª store
const { isLogin } = useUserStore() // ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½ä¼šé‡æ–°æ¸²æŸ“
```

### 3. Action å‘½å

```typescript
// âœ… æ¨èï¼šä½¿ç”¨è¯­ä¹‰åŒ–çš„ action åç§°
login(token, userInfo)    // æ¸…æ™°è¡¨è¾¾æ„å›¾
logout()
updateUserInfo(data)

// âŒ ä¸æ¨èï¼šä½¿ç”¨é€šç”¨çš„ set æ–¹æ³•
setState({ ... })         // ä¸å¤Ÿè¯­ä¹‰åŒ–
```

### 4. ç±»å‹å®‰å…¨

```typescript
// âœ… æ¨èï¼šå®šä¹‰å®Œæ•´çš„ç±»å‹
interface UserState {
  token: string | null
  userInfo: UserInfo | null
  isLogin: boolean
  login: (token: string, userInfo: UserInfo) => void
  logout: () => void
}

// âŒ ä¸æ¨èï¼šä½¿ç”¨ any æˆ–ä¸å®šä¹‰ç±»å‹
interface UserState {
  token: any
  userInfo: any
  login: (data: any) => void
}
```

### 5. æŒä¹…åŒ–é…ç½®

```typescript
// âœ… æ¨èï¼šåªæŒä¹…åŒ–éœ€è¦çš„å­—æ®µ
persist(
  (set, get) => ({ /* state and actions */ }),
  {
    name: 'user-storage',
    partialize: state => ({
      token: state.token,
      userInfo: state.userInfo,
      // ä¸æŒä¹…åŒ– loading ç­‰ä¸´æ—¶çŠ¶æ€
    }),
  }
)

// âŒ ä¸æ¨èï¼šæŒä¹…åŒ–æ‰€æœ‰çŠ¶æ€ï¼ˆåŒ…æ‹¬ä¸´æ—¶çŠ¶æ€ï¼‰
persist(
  (set, get) => ({ /* state and actions */ }),
  {
    name: 'user-storage',
    // æ²¡æœ‰ partializeï¼Œæ‰€æœ‰çŠ¶æ€éƒ½ä¼šæŒä¹…åŒ–
  }
)
```

## ğŸš€ åˆ›å»ºæ–° Store æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»º Store æ–‡ä»¶

åœ¨ `src/store/modules/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶ï¼Œå¦‚ `cartStore.ts`ï¼š

```typescript
import { create } from 'zustand'

interface CartItem {
  id: number
  name: string
  price: number
  quantity: number
}

interface CartState {
  items: CartItem[]
  total: number

  addItem: (item: CartItem) => void
  removeItem: (id: number) => void
  updateQuantity: (id: number, quantity: number) => void
  clearCart: () => void
  getTotal: () => number
}

export const useCartStore = create<CartState>()((set, get) => ({
  items: [],
  total: 0,

  addItem: item => {
    set(state => {
      const existingItem = state.items.find(i => i.id === item.id)

      if (existingItem) {
        // å¦‚æœå•†å“å·²å­˜åœ¨ï¼Œå¢åŠ æ•°é‡
        return {
          items: state.items.map(i =>
            i.id === item.id
              ? { ...i, quantity: i.quantity + 1 }
              : i
          ),
        }
      } else {
        // å¦åˆ™æ·»åŠ æ–°å•†å“
        return {
          items: [...state.items, { ...item, quantity: 1 }],
        }
      }
    })

    // æ›´æ–°æ€»ä»·
    get().getTotal()
  },

  removeItem: id => {
    set(state => ({
      items: state.items.filter(item => item.id !== id),
    }))
    get().getTotal()
  },

  updateQuantity: (id, quantity) => {
    set(state => ({
      items: state.items.map(item =>
        item.id === id ? { ...item, quantity } : item
      ),
    }))
    get().getTotal()
  },

  clearCart: () => {
    set({ items: [], total: 0 })
  },

  getTotal: () => {
    const total = get().items.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    )
    set({ total })
    return total
  },
}))

// å¯¼å‡ºé€‰æ‹©å™¨
export const useCartItems = () => useCartStore(state => state.items)
export const useCartTotal = () => useCartStore(state => state.total)
export const useCartItemCount = () =>
  useCartStore(state => state.items.reduce((sum, item) => sum + item.quantity, 0))
```

### æ­¥éª¤ 2: å¯¼å‡º Store

åœ¨ `src/store/index.ts` ä¸­å¯¼å‡ºï¼š

```typescript
export * from './modules/userStore'
export * from './modules/appStore'
export * from './modules/cartStore'  // æ–°å¢
```

### æ­¥éª¤ 3: åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```typescript
import { useCartStore, useCartItems, useCartTotal } from '@/store'

function Cart() {
  const items = useCartItems()
  const total = useCartTotal()
  const { addItem, removeItem, updateQuantity, clearCart } = useCartStore()

  return (
    <div>
      <h2>è´­ç‰©è½¦ ({items.length} ä»¶å•†å“)</h2>

      {items.map(item => (
        <div key={item.id}>
          <span>{item.name}</span>
          <span>Â¥{item.price}</span>
          <input
            type="number"
            value={item.quantity}
            onChange={e => updateQuantity(item.id, Number(e.target.value))}
          />
          <button onClick={() => removeItem(item.id)}>åˆ é™¤</button>
        </div>
      ))}

      <div>æ€»ä»·ï¼šÂ¥{total}</div>
      <button onClick={clearCart}>æ¸…ç©ºè´­ç‰©è½¦</button>
    </div>
  )
}
```

## ğŸ”Œ ä¸­é—´ä»¶

### 1. Persist - æŒä¹…åŒ–

```typescript
import { persist, createJSONStorage } from 'zustand/middleware'

export const useUserStore = create<UserState>()(
  persist(
    (set, get) => ({ /* state */ }),
    {
      name: 'user-storage',           // localStorage key
      storage: createJSONStorage(() => localStorage),

      // åªæŒä¹…åŒ–éƒ¨åˆ†å­—æ®µ
      partialize: state => ({
        token: state.token,
        userInfo: state.userInfo,
      }),

      // ç‰ˆæœ¬æ§åˆ¶å’Œè¿ç§»
      version: 1,
      migrate: (persistedState, version) => {
        if (version === 0) {
          // è¿ç§»æ—§ç‰ˆæœ¬æ•°æ®
          return {
            ...persistedState,
            newField: 'default value',
          }
        }
        return persistedState
      },
    }
  )
)
```

### 2. DevTools - å¼€å‘å·¥å…·

```typescript
import { devtools } from 'zustand/middleware'

export const useUserStore = create<UserState>()(
  devtools(
    (set, get) => ({ /* state */ }),
    { name: 'UserStore' }  // åœ¨ Redux DevTools ä¸­æ˜¾ç¤ºçš„åç§°
  )
)
```

### 3. ç»„åˆå¤šä¸ªä¸­é—´ä»¶

```typescript
import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'

export const useUserStore = create<UserState>()(
  devtools(
    persist(
      (set, get) => ({ /* state */ }),
      { name: 'user-storage' }
    ),
    { name: 'UserStore' }
  )
)
```

## ğŸ”„ ä¸ç³»ç»Ÿé›†æˆ

### 1. è·¯ç”±å®ˆå«é›†æˆ

```typescript
// src/router/AuthGuard.tsx
import { FC, ReactNode } from 'react'
import { Navigate } from 'react-router-dom'
import { useIsLogin } from '@/store'

interface AuthGuardProps {
  children: ReactNode
}

const AuthGuard: FC<AuthGuardProps> = ({ children }) => {
  const isLogin = useIsLogin()

  if (!isLogin) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}

export default AuthGuard
```

### 2. API æ‹¦æˆªå™¨é›†æˆ

```typescript
// src/utils/request.ts
import { useUserStore } from '@/store'

// è¯·æ±‚æ‹¦æˆªå™¨
http.interceptors.request.use(config => {
  const token = useUserStore.getState().token
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // token è¿‡æœŸï¼Œè‡ªåŠ¨ç™»å‡º
      useUserStore.getState().logout()
      Toast.show({ content: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•' })
    }
    return Promise.reject(error)
  }
)
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åœ¨ç»„ä»¶å¤–ä½¿ç”¨ store?

```typescript
// âœ… ä½¿ç”¨ getState()
const token = useUserStore.getState().token
useUserStore.getState().logout()
```

### Q: å¦‚ä½•è®¢é˜…å¤šä¸ª store?

```typescript
// âœ… ç›´æ¥ä½¿ç”¨å¤šä¸ª hooks
const { userInfo } = useUserStore()
const { theme } = useAppStore()
const { items } = useCartStore()
```

### Q: çŠ¶æ€æ›´æ–°åç»„ä»¶ä¸é‡æ–°æ¸²æŸ“?

```typescript
// âŒ å¯èƒ½ä¸ä¼šè§¦å‘æ›´æ–°ï¼ˆå¼•ç”¨æ¯”è¾ƒï¼‰
const user = useUserStore(state => state.userInfo)

// âœ… æ­£ç¡®çš„ç”¨æ³•
const { userInfo } = useUserStore()

// âœ… æˆ–ä½¿ç”¨å¯¼å‡ºçš„é€‰æ‹©å™¨
const userInfo = useUserInfo()
```

### Q: å¦‚ä½•é‡ç½® store åˆ°åˆå§‹çŠ¶æ€?

```typescript
// âœ… åˆ›å»ºä¸€ä¸ª reset action
export const useUserStore = create<UserState>()((set) => ({
  // ... states

  reset: () => {
    set({
      token: null,
      userInfo: null,
      isLogin: false,
    })
  },
}))
```

## ğŸ“Š ä¸å…¶ä»–çŠ¶æ€ç®¡ç†åº“å¯¹æ¯”

### Zustand vs Redux

| ç‰¹æ€§ | Zustand | Redux |
|------|---------|-------|
| åŒ…å¤§å° | 1.2KB | ~15KB |
| æ ·æ¿ä»£ç  | æå°‘ | è¾ƒå¤š |
| å­¦ä¹ æ›²çº¿ | ä½ | é«˜ |
| TypeScript | åŸç”Ÿæ”¯æŒ | éœ€è¦é¢å¤–é…ç½® |
| DevTools | æ”¯æŒ | æ”¯æŒ |
| ä¸­é—´ä»¶ | ç®€å• | å¤æ‚ |

### Zustand vs Context API

| ç‰¹æ€§ | Zustand | Context |
|------|---------|---------|
| æ€§èƒ½ | ä¼˜ç§€ | ä¸€èˆ¬ |
| é‡æ¸²æŸ“ | ç»†ç²’åº¦æ§åˆ¶ | å®¹æ˜“è¿‡åº¦æ¸²æŸ“ |
| ä½¿ç”¨å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ |
| æŒä¹…åŒ– | å†…ç½®ä¸­é—´ä»¶ | éœ€è‡ªè¡Œå®ç° |

## ğŸš« å¸¸è§é”™è¯¯

```typescript
// âŒ é”™è¯¯ 1: ç›´æ¥ä¿®æ”¹çŠ¶æ€
const { items } = useCartStore()
items.push(newItem)  // é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ action
const { addItem } = useCartStore()
addItem(newItem)

// âŒ é”™è¯¯ 2: åœ¨ set å¤–éƒ¨ä½¿ç”¨ get
const total = get().total  // é”™è¯¯ï¼åªèƒ½åœ¨ create å‡½æ•°å†…ä½¿ç”¨

// âœ… æ­£ç¡®ï¼šåœ¨ action å†…ä½¿ç”¨ get
addItem: item => {
  const currentTotal = get().total  // æ­£ç¡®
  // ...
}

// âŒ é”™è¯¯ 3: å¼‚æ­¥ action ä¸­ä¸æ­£ç¡®çš„çŠ¶æ€æ›´æ–°
addItem: async item => {
  const res = await api.addItem(item)
  set({ items: get().items.concat(res) })  // å¯èƒ½è·å–åˆ°æ—§çŠ¶æ€
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‡½æ•°å¼æ›´æ–°
addItem: async item => {
  const res = await api.addItem(item)
  set(state => ({ items: [...state.items, res] }))
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Zustand å®˜æ–¹æ–‡æ¡£](https://docs.pmnd.rs/zustand/getting-started/introduction)
- [Zustand GitHub](https://github.com/pmndrs/zustand)
- [é¡¹ç›®çŠ¶æ€ç®¡ç†æŒ‡å—](mdc:docs/ZUSTAND_GUIDE.md)
- [ç”¨æˆ· Store ç¤ºä¾‹](mdc:src/store/modules/userStore.ts)
- [åº”ç”¨ Store ç¤ºä¾‹](mdc:src/store/modules/appStore.ts)
