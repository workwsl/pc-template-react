---
globs: src/utils/**/*
description: å·¥å…·å‡½æ•°è§„èŒƒ - è¯·æ±‚å°è£…ã€å­˜å‚¨å·¥å…·ã€æ ¼å¼åŒ–å·¥å…·ã€è®¾å¤‡æ£€æµ‹
---

# å·¥å…·å‡½æ•°è§„èŒƒ

## ğŸ“ ç›®å½•ç»“æ„

```
src/utils/
â”œâ”€â”€ index.ts           # å·¥å…·å‡½æ•°ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ request.ts         # HTTP è¯·æ±‚å°è£…ï¼ˆAxios + æ‹¦æˆªå™¨ï¼‰
â”œâ”€â”€ storage.ts         # æœ¬åœ°å­˜å‚¨å·¥å…·ï¼ˆæ”¯æŒè¿‡æœŸæ—¶é—´ï¼‰
â”œâ”€â”€ format.ts          # æ ¼å¼åŒ–å·¥å…·ï¼ˆæ‰‹æœºå·ã€é‡‘é¢ã€æ—¥æœŸç­‰ï¼‰
â””â”€â”€ device.ts          # è®¾å¤‡æ£€æµ‹å·¥å…·ï¼ˆiOSã€Androidã€å¾®ä¿¡ç­‰ï¼‰
```

## ğŸŒ HTTP è¯·æ±‚å·¥å…·ï¼ˆrequest.tsï¼‰

### åŠŸèƒ½ç‰¹æ€§

- âœ… åŸºäº Axios å°è£…
- âœ… è¯·æ±‚/å“åº”æ‹¦æˆªå™¨
- âœ… è‡ªåŠ¨æ·»åŠ  token
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… 401 è‡ªåŠ¨ç™»å‡º
- âœ… TypeScript ç±»å‹æ”¯æŒ

### åŸºæœ¬ä½¿ç”¨

å‚è€ƒæ–‡ä»¶ï¼š[src/utils/request.ts](mdc:src/utils/request.ts)

```typescript
import { http } from '@/utils/request'

// GET è¯·æ±‚
const users = await http.get<User[]>('/users')
const user = await http.get<User>('/users/1')

// POST è¯·æ±‚
const result = await http.post<UserLoginResponse>('/login', {
  username: 'admin',
  password: '123456',
})

// PUT è¯·æ±‚
const updated = await http.put<User>('/users/1', {
  email: 'new@example.com',
})

// DELETE è¯·æ±‚
await http.delete<void>('/users/1')

// PATCH è¯·æ±‚
const patched = await http.patch<User>('/users/1', {
  phone: '13800138000',
})
```

### å¸¦å‚æ•°çš„è¯·æ±‚

```typescript
// GET è¯·æ±‚å¸¦æŸ¥è¯¢å‚æ•°
const users = await http.get<UserListResponse>('/users', {
  params: {
    page: 1,
    pageSize: 10,
    keyword: 'john',
  },
})

// POST è¯·æ±‚å¸¦é…ç½®
const result = await http.post<User>('/users', data, {
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 5000,
})
```

### è‡ªå®šä¹‰æ‹¦æˆªå™¨

```typescript
// è¯·æ±‚æ‹¦æˆªå™¨
http.interceptors.request.use(
  config => {
    // æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´
    config.headers['X-Custom-Header'] = 'value'

    // æ·»åŠ æ—¶é—´æˆ³
    config.params = {
      ...config.params,
      _t: Date.now(),
    }

    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(
  response => {
    // å¤„ç†å“åº”æ•°æ®
    return response.data
  },
  error => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error.response?.status === 404) {
      Toast.show({ content: 'èµ„æºä¸å­˜åœ¨' })
    }
    return Promise.reject(error)
  }
)
```

## ğŸ’¾ æœ¬åœ°å­˜å‚¨å·¥å…·ï¼ˆstorage.tsï¼‰

### åŠŸèƒ½ç‰¹æ€§

- âœ… æ”¯æŒè¿‡æœŸæ—¶é—´
- âœ… è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… TypeScript ç±»å‹æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†

### åŸºæœ¬ä½¿ç”¨

å‚è€ƒæ–‡ä»¶ï¼š[src/utils/storage.ts](mdc:src/utils/storage.ts)

```typescript
import { storage } from '@/utils'

// è®¾ç½®å­˜å‚¨ï¼ˆæ°¸ä¹…ï¼‰
storage.set('user', { id: 1, name: 'John' })

// è®¾ç½®å­˜å‚¨ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼‰
storage.set('token', 'abc123', 3600)  // 1 å°æ—¶åè¿‡æœŸ

// è·å–å­˜å‚¨
const user = storage.get<User>('user')
const token = storage.get<string>('token')

// åˆ é™¤å­˜å‚¨
storage.remove('token')

// æ¸…ç©ºæ‰€æœ‰å­˜å‚¨
storage.clear()

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
const hasToken = storage.has('token')
```

### å®é™…åº”ç”¨

```typescript
// ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆ7 å¤©ï¼‰
const cacheUserInfo = (userInfo: UserInfo) => {
  storage.set('userInfo', userInfo, 7 * 24 * 3600)
}

// è·å–ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
const getCachedUserInfo = (): UserInfo | null => {
  return storage.get<UserInfo>('userInfo')
}

// ç¼“å­˜ API å“åº”ï¼ˆ1 å°æ—¶ï¼‰
const cacheApiResponse = (key: string, data: any) => {
  storage.set(`api_${key}`, data, 3600)
}

// è·å–ç¼“å­˜çš„ API å“åº”
const getCachedApiResponse = <T>(key: string): T | null => {
  return storage.get<T>(`api_${key}`)
}
```

## ğŸ¨ æ ¼å¼åŒ–å·¥å…·ï¼ˆformat.tsï¼‰

### åŠŸèƒ½ç‰¹æ€§

- âœ… æ‰‹æœºå·æ ¼å¼åŒ–
- âœ… é‡‘é¢æ ¼å¼åŒ–
- âœ… æ—¥æœŸæ ¼å¼åŒ–
- âœ… æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
- âœ… æ•°å­—æ ¼å¼åŒ–

### åŸºæœ¬ä½¿ç”¨

å‚è€ƒæ–‡ä»¶ï¼š[src/utils/format.ts](mdc:src/utils/format.ts)

```typescript
import {
  formatPhone,
  formatMoney,
  formatDate,
  formatFileSize,
  formatNumber
} from '@/utils'

// æ ¼å¼åŒ–æ‰‹æœºå·
formatPhone('13800138000')           // => '138****8000'
formatPhone('13800138000', ' ')      // => '138 0013 8000'

// æ ¼å¼åŒ–é‡‘é¢
formatMoney(1234.5)                  // => 'Â¥1,234.50'
formatMoney(1234.5, 0)               // => 'Â¥1,235'
formatMoney(1234.5, 2, '$')          // => '$1,234.50'

// æ ¼å¼åŒ–æ—¥æœŸ
formatDate(Date.now())               // => '2024-01-01 12:00:00'
formatDate(Date.now(), 'YYYY-MM-DD') // => '2024-01-01'
formatDate(Date.now(), 'HH:mm:ss')   // => '12:00:00'

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
formatFileSize(1024)                 // => '1.00 KB'
formatFileSize(1024 * 1024)          // => '1.00 MB'
formatFileSize(1024 * 1024 * 1024)   // => '1.00 GB'

// æ ¼å¼åŒ–æ•°å­—
formatNumber(1234567)                // => '1,234,567'
formatNumber(1234567.89, 2)          // => '1,234,567.89'
```

### å®é™…åº”ç”¨

```typescript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const UserCard: FC<{ user: User }> = ({ user }) => {
  return (
    <div>
      <p>æ‰‹æœºå·ï¼š{formatPhone(user.phone)}</p>
      <p>ä½™é¢ï¼š{formatMoney(user.balance)}</p>
      <p>æ³¨å†Œæ—¶é—´ï¼š{formatDate(user.createdAt)}</p>
    </div>
  )
}

// åœ¨åˆ—è¡¨ä¸­ä½¿ç”¨
const ProductList: FC<{ products: Product[] }> = ({ products }) => {
  return (
    <div>
      {products.map(product => (
        <div key={product.id}>
          <span>{product.name}</span>
          <span>{formatMoney(product.price)}</span>
        </div>
      ))}
    </div>
  )
}
```

## ğŸ“± è®¾å¤‡æ£€æµ‹å·¥å…·ï¼ˆdevice.tsï¼‰

### åŠŸèƒ½ç‰¹æ€§

- âœ… iOS/Android æ£€æµ‹
- âœ… å¾®ä¿¡/æ”¯ä»˜å®æ£€æµ‹
- âœ… æµè§ˆå™¨ç±»å‹æ£€æµ‹
- âœ… ç§»åŠ¨ç«¯/PC ç«¯æ£€æµ‹

### åŸºæœ¬ä½¿ç”¨

å‚è€ƒæ–‡ä»¶ï¼š[src/utils/device.ts](mdc:src/utils/device.ts)

```typescript
import {
  isIOS,
  isAndroid,
  isWeChat,
  isAlipay,
  isMobile,
  getBrowser
} from '@/utils'

// æ£€æµ‹æ“ä½œç³»ç»Ÿ
if (isIOS()) {
  console.log('iOS è®¾å¤‡')
}

if (isAndroid()) {
  console.log('Android è®¾å¤‡')
}

// æ£€æµ‹åº”ç”¨ç¯å¢ƒ
if (isWeChat()) {
  console.log('å¾®ä¿¡ç¯å¢ƒ')
  // è°ƒç”¨å¾®ä¿¡ JSSDK
}

if (isAlipay()) {
  console.log('æ”¯ä»˜å®ç¯å¢ƒ')
  // è°ƒç”¨æ”¯ä»˜å® JSSDK
}

// æ£€æµ‹è®¾å¤‡ç±»å‹
if (isMobile()) {
  console.log('ç§»åŠ¨ç«¯è®¾å¤‡')
} else {
  console.log('PC ç«¯è®¾å¤‡')
}

// è·å–æµè§ˆå™¨ç±»å‹
const browser = getBrowser()
console.log(browser) // 'chrome', 'safari', 'firefox', etc.
```

### å®é™…åº”ç”¨

```typescript
// æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒçš„åˆ†äº«åŠŸèƒ½
const ShareButton: FC = () => {
  const handleShare = () => {
    if (isWeChat()) {
      // å¾®ä¿¡åˆ†äº«
      wx.updateAppMessageShareData({ ... })
    } else if (isAlipay()) {
      // æ”¯ä»˜å®åˆ†äº«
      ap.share({ ... })
    } else {
      // ä½¿ç”¨ Web Share API
      navigator.share({ ... })
    }
  }

  return <button onClick={handleShare}>åˆ†äº«</button>
}

// æ ¹æ®è®¾å¤‡æ˜¾ç¤ºä¸åŒçš„ä¸‹è½½æç¤º
const DownloadTip: FC = () => {
  if (isIOS()) {
    return <div>åœ¨ App Store ä¸‹è½½</div>
  }

  if (isAndroid()) {
    return <div>åœ¨åº”ç”¨å¸‚åœºä¸‹è½½</div>
  }

  return null
}
```

## ğŸ“ åˆ›å»ºæ–°å·¥å…·å‡½æ•°

### 1. å‡½æ•°è®¾è®¡åŸåˆ™

```typescript
// âœ… æ¨èï¼šçº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨
export const formatPhone = (phone: string): string => {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

// âŒ ä¸æ¨èï¼šæœ‰å‰¯ä½œç”¨çš„å‡½æ•°
let lastPhone = ''
export const formatPhone = (phone: string): string => {
  lastPhone = phone  // ä¿®æ”¹å¤–éƒ¨å˜é‡
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}
```

### 2. å®Œæ•´çš„ç±»å‹å®šä¹‰

```typescript
// âœ… æ¨èï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰
export const formatMoney = (
  amount: number,
  decimals: number = 2,
  symbol: string = 'Â¥'
): string => {
  const formatted = amount.toFixed(decimals)
  const parts = formatted.split('.')
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',')
  return `${symbol}${parts.join('.')}`
}

// âŒ ä¸æ¨èï¼šç¼ºå°‘ç±»å‹å®šä¹‰æˆ–ä½¿ç”¨ any
export const formatMoney = (amount: any, decimals?: any, symbol?: any) => {
  // ...
}
```

### 3. æ·»åŠ  JSDoc æ³¨é‡Š

```typescript
/**
 * æ ¼å¼åŒ–æ‰‹æœºå·ï¼Œä¸­é—´å››ä½æ˜¾ç¤ºä¸ºæ˜Ÿå·
 *
 * @param phone - åŸå§‹æ‰‹æœºå·ï¼ˆ11 ä½ï¼‰
 * @param separator - åˆ†éš”ç¬¦ï¼ˆå¯é€‰ï¼‰
 * @returns æ ¼å¼åŒ–åçš„æ‰‹æœºå·
 * @example
 * ```ts
 * formatPhone('13800138000')      // => '138****8000'
 * formatPhone('13800138000', ' ') // => '138 0013 8000'
 * ```
 */
export const formatPhone = (
  phone: string,
  separator?: string
): string => {
  if (separator) {
    return phone.replace(/(\d{3})(\d{4})(\d{4})/, `$1${separator}$2${separator}$3`)
  }
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}
```

### 4. é”™è¯¯å¤„ç†

```typescript
// âœ… æ¨èï¼šå®Œå–„çš„é”™è¯¯å¤„ç†
export const parseJSON = <T>(str: string, defaultValue?: T): T | null => {
  try {
    return JSON.parse(str) as T
  } catch (error) {
    console.error('JSON è§£æå¤±è´¥:', error)
    return defaultValue ?? null
  }
}

// âŒ ä¸æ¨èï¼šæ²¡æœ‰é”™è¯¯å¤„ç†
export const parseJSON = <T>(str: string): T => {
  return JSON.parse(str) as T  // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
}
```

### 5. å•å…ƒæµ‹è¯•

```typescript
// âœ… æ¨èï¼šç¼–å†™å•å…ƒæµ‹è¯•
describe('formatPhone', () => {
  it('åº”è¯¥æ ¼å¼åŒ–æ‰‹æœºå·', () => {
    expect(formatPhone('13800138000')).toBe('138****8000')
  })

  it('åº”è¯¥æ”¯æŒè‡ªå®šä¹‰åˆ†éš”ç¬¦', () => {
    expect(formatPhone('13800138000', ' ')).toBe('138 0013 8000')
  })

  it('åº”è¯¥å¤„ç†ç©ºå­—ç¬¦ä¸²', () => {
    expect(formatPhone('')).toBe('')
  })
})
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å·¥å…·å‡½æ•°å¯¼å‡º

```typescript
// src/utils/index.ts

// âœ… æ¨èï¼šç»Ÿä¸€å¯¼å‡º
export * from './request'
export * from './storage'
export * from './format'
export * from './device'

// è¿™æ ·å¯ä»¥ä» @/utils ç»Ÿä¸€å¯¼å…¥
import { http, storage, formatPhone, isIOS } from '@/utils'
```

### 2. é¿å…å¾ªç¯ä¾èµ–

```typescript
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¾èµ–
// utils/a.ts
import { funcB } from './b'

// utils/b.ts
import { funcA } from './a'  // å¾ªç¯ä¾èµ–ï¼

// âœ… æ­£ç¡®ï¼šæå–å…±åŒä¾èµ–
// utils/common.ts
export const sharedFunc = () => {}

// utils/a.ts
import { sharedFunc } from './common'

// utils/b.ts
import { sharedFunc } from './common'
```

### 3. ä¿æŒå‡½æ•°ç®€æ´

```typescript
// âœ… æ¨èï¼šå•ä¸€èŒè´£
export const formatPhone = (phone: string): string => {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

export const validatePhone = (phone: string): boolean => {
  return /^1[3-9]\d{9}$/.test(phone)
}

// âŒ ä¸æ¨èï¼šå‡½æ•°è¿‡äºå¤æ‚
export const handlePhone = (phone: string, action: 'format' | 'validate') => {
  if (action === 'format') {
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
  } else if (action === 'validate') {
    return /^1[3-9]\d{9}$/.test(phone)
  }
}
```

### 4. ä½¿ç”¨ Tree-shaking

```typescript
// âœ… æ¨èï¼šå¯¼å‡ºå…·åå‡½æ•°
export const formatPhone = () => {}
export const formatMoney = () => {}

// âŒ ä¸æ¨èï¼šå¯¼å‡ºå¯¹è±¡ï¼ˆä¸åˆ©äº Tree-shakingï¼‰
export default {
  formatPhone: () => {},
  formatMoney: () => {},
}
```

## ğŸš« å¸¸è§é”™è¯¯

```typescript
// âŒ é”™è¯¯ 1: ä¿®æ”¹å‚æ•°
export const updateUser = (user: User) => {
  user.updatedAt = Date.now()  // ç›´æ¥ä¿®æ”¹å‚æ•°
  return user
}

// âœ… æ­£ç¡®ï¼šè¿”å›æ–°å¯¹è±¡
export const updateUser = (user: User) => {
  return {
    ...user,
    updatedAt: Date.now(),
  }
}

// âŒ é”™è¯¯ 2: ä½¿ç”¨å…¨å±€å˜é‡
let cache = {}
export const getCache = (key: string) => {
  return cache[key]
}

// âœ… æ­£ç¡®ï¼šé¿å…å…¨å±€çŠ¶æ€
export const createCache = () => {
  const cache = {}
  return {
    get: (key: string) => cache[key],
    set: (key: string, value: any) => cache[key] = value,
  }
}

// âŒ é”™è¯¯ 3: ç¼ºå°‘ç±»å‹å®šä¹‰
export const formatDate = (date) => {
  return new Date(date).toISOString()
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰
export const formatDate = (date: Date | number | string): string => {
  return new Date(date).toISOString()
}

// âŒ é”™è¯¯ 4: æ²¡æœ‰é”™è¯¯å¤„ç†
export const parseJSON = (str: string) => {
  return JSON.parse(str)  // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ é”™è¯¯å¤„ç†
export const parseJSON = <T>(str: string): T | null => {
  try {
    return JSON.parse(str) as T
  } catch (error) {
    console.error('JSON è§£æå¤±è´¥:', error)
    return null
  }
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [HTTP è¯·æ±‚å·¥å…·](mdc:src/utils/request.ts)
- [å­˜å‚¨å·¥å…·](mdc:src/utils/storage.ts)
- [æ ¼å¼åŒ–å·¥å…·](mdc:src/utils/format.ts)
- [è®¾å¤‡æ£€æµ‹å·¥å…·](mdc:src/utils/device.ts)
- [é¡¹ç›®ç»“æ„æŒ‡å—](mdc:docs/PROJECT_GUIDE.md)

## ğŸ¯ å·¥å…·å‡½æ•°æ£€æŸ¥æ¸…å•

- [ ] å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨
- [ ] å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- [ ] æ·»åŠ  JSDoc æ³¨é‡Š
- [ ] åŒ…å«ä½¿ç”¨ç¤ºä¾‹
- [ ] æ·»åŠ é”™è¯¯å¤„ç†
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] å‡½æ•°ä¿æŒç®€æ´ï¼ˆä¸è¶…è¿‡ 50 è¡Œï¼‰
- [ ] é¿å…ä½¿ç”¨ any ç±»å‹
- [ ] åœ¨ utils/index.ts ä¸­å¯¼å‡º
